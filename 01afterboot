#!/system/bin/sh
# this is a W.I.P. script.

# enable OC'ing
## (0 = disabled) (1 = enabled)
	OC=0

# CPU Interactive Governor fix.
	echo 612000 > /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq
	echo "65 510000:75 714000:85" > /sys/devices/system/cpu/cpufreq/interactive/target_loads
# lock them now
	chmod 444 /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq
	chmod 444 /sys/devices/system/cpu/cpufreq/interactive/target_loads

# fsync.
## (0 = disabled) (1 = enabled)
	echo 1 > /sys/module/sync/parameters/fsync_enabled

# fast charge.
## (0 = disabled) (1 = enabled)
	echo 1 > /sys/kernel/fast_charge/force_fast_charge

# its here just to be here
# if disabled you will get problems with sleep.
	#echo 0 > /sys/devices/platform/spi-tegra114.2/spi_master/spi2/spi2.0/input/input0/wake_gesture

# debug set to NO.
	echo N > /sys/kernel/debug/debug_enabled

#   ------------------------<MEMORY>-----------------------   #

# Ultra Kernel Samepage Merging
## (0 = disabled) (1 = enabled)
	echo 1 > /sys/kernel/mm/uksm/run

# config swap.
	echo 60 > /proc/sys/vm/swappiness
	#echo 1 > /proc/sys/vm/page-cluster

# Low Memory Killer config for swap
	echo "17920,20480,23040,25600,28160,30720" > /sys/module/lowmemorykiller/parameters/minfree

# ZRAM
## (0 = disabled) (1 = enabled)
# zswap and aswap must be disabled.
# zsize is how big zram will be.
# it's in MB.
	zram=0
	zsize=0

# cache swap
## (0 = disabled) (1 = enabled)
# it will make a 130mb swap file
# in /cache named swap
# czsize must not go over 150
# or f2fs /cache wont work.
# it's in MB.
	cswap=1
	czsize=130

# use zram with cache
## (0 = disabled) (1 = enabled)
# with a raid 0 like way.
	zswap=1

# make cache all swap
## (0 = disabled) (1 = enabled)
	aswap=0

#   ------------------------<EXPERT>-----------------------   #

if [ "$cswap" == "1" ] && [ "$aswap" == "0" ] && [ "$zswap" == "0" ] && [ -e /cache/swap ]; then
	chmod 1777 /cache/swap
	mkswap /cache/swap
	swapon -p 1 /cache/swap
elif [ "$cswap" == "1" ] && [ "$aswap" == "0" ]; then
	if [ -e /cache/swap ]; then
		chmod 1777 /cache/swap
		mkswap /cache/swap
	else
		dd if=/dev/zero of=/cache/swap bs=1m count=$czsize
		chmod 1777 /cache/swap
		mkswap /cache/swap
	fi
	if [ "$zram" == "1" ]; then
		swapon -p 2 /cache/swap
	else
		swapon -p 1 /cache/swap
	fi
	if [ "$zswap" == "1" ]; then
		swapoff /dev/block/zram0
		echo 1 > /sys/block/zram0/reset
		echo lz4 > /sys/block/zram0/comp_algorithm
		echo "$czsize"M > /sys/block/zram0/disksize
		mkswap /dev/block/zram0
		swapon -p 1 /dev/block/zram0
	fi
fi
if [ "$aswap" == "1" ]; then
	umount /cache
	busybox mount -t tmpfs -o rw,noatime tmpfs /cache
	mkswap /dev/block/platform/sdhci-tegra.3/by-name/CAC
	swapoff /dev/block/zram0
	swapon -p 1 /dev/block/platform/sdhci-tegra.3/by-name/CAC
	if [ "$zswap" == "1" ]; then
		swapoff /dev/block/zram0
		echo 1 > /sys/block/zram0/reset
		echo lz4 > /sys/block/zram0/comp_algorithm
		echo 260M > /sys/block/zram0/disksize
		mkswap /dev/block/zram0
		swapon -p 1 /dev/block/zram0
	fi
fi
if [ -e /cache/swap ] && [ "$cswap" == "0" ] && [ "$zswap" == "0" ] && [ "$aswap" == "0" ]; then
	chmod 777 /cache/swap
	rm /cache/swap
elif [ "$zram" == "1" ] && [ "$zswap" == "0" ] && [ "$aswap" == "0" ]; then
	echo 1 > /sys/block/zram0/reset
	echo lz4 > /sys/block/zram0/comp_algorithm
	echo "$zsize"M > /sys/block/zram0/disksize
	mkswap /dev/block/zram0
	swapon -p 1 /dev/block/zram0
fi
if [ "$OC" == "1" ]; then
	echo 2499000 > /sys/module/cpu_tegra/parameters/cpu_user_cap
elif [ "$OC" == "0" ]; then
	# there's no reason to have the gpu
	# speed set so high, so lets make it slower.
	echo 1 > /sys/kernel/tegra_gpu/gpu_cap_state
	echo 852000000 > /sys/kernel/tegra_gpu/gpu_cap_rate
fi
	
