#!/system/bin/sh
#
# W.I.P. script, by USBhost. made for the Nexus 9.
#
# i use busybox for some commands because
# some of them are newer.
#

	# busybox location
BB=/system/etc/BB/busybox
	# zram's sys interface
ZRS=/sys/block/zram0
	# zram's block device
ZRB=/dev/block/zram0
	# cpu cores
CORE="$(cat /proc/cpuinfo | grep -c processor)"
	# override file
ORID=/sdcard/override
	# cache partition location
CACHE=/dev/block/platform/sdhci-tegra.3/by-name/CAC
	# cache partition size
PSIZE=260 # PSIZE is in MB
	# swap file
CSWAP=/cache/swap
	# if /cache is mounted
CMOUNT=/cache/mounted
	# for info logs
LOGCATI="log -p i -t FI.d:01afterboot"
	# for warning logs
LOGCATW="log -p w -t FI.d:01afterboot"

	# check cswap file size #FIXME: this is inefficient 
SIZE="$($BB du -h $CSWAP | grep -o '[0-9]*')"


$LOGCATI " FIRE-ICE script v36 "

# overclocking.
# GPU 0.984 ghz
## (0 = disabled) (1 = enabled)
	oc=0

# CPU Interactive Governor fix.
# this will increase battery life
# Note: but adding some lag
## (0 = disabled) (1 = enabled)
	gfix=0

# fsync
## (0 = disabled) (1 = default/enabled)
	fs=1

# fast charge.
## (0 = default/disabled) (1 = enabled)
	fc=1

# double tap to wake
## (0 = disabled) (1 = default/enabled)
	dtw=1

# set debug to NO.
	echo 0 > /sys/kernel/debug/debug_enabled

# for entropy 
	echo 1 > /sys/block/mmcblk0/queue/add_random
	echo 1 > /sys/block/zram0/queue/add_random

#   ------------------------<MEMORY>-----------------------   #

# tweak memory
	echo 10940 > /proc/sys/vm/extra_free_kbytes # double min_free_kbytes
	echo 100 > /proc/sys/vm/vfs_cache_pressure # set to 100 some ROMs make it lower
	echo 100 > /proc/sys/vm/swappiness # try to use swap for lmk

# Ultra Kernel Samepage Merging
# hmm... does not seem to do much good on MM.
# You should not enable UKSM if your using zram
# because uksm will not work on swap memory.
# If zram is enabled there will be less memory
# for uksm to work on aka just wasting battery.
## (0 = default/disabled) (1 = enabled) ##
	uksm=0
	ksm=0 # only use this if uksm is not compiled in the kernel

# Low Memory Killer.
# ONLY! if your vary, vary memory conscious
# and always clears recents, then you disable this,
# if your not things will go vary vary bad!
## (0 = disabled) (1 = default/enabled) (2 = custom/enabled) ##
	lmk=2

# ZRAM Only.
# "aswap" will be null.
# You can still use cswap but it
# will be second priority.
## (0 = disabled) ##
	zswap=500 # "zswap" is in MB.

# Make a swap file in /cache.
# "cswap" must not go over 150
# or f2fs /cache will not work.
## (0 = disabled) ##
	cswap=0 # "cswap" is in MB.

# Make /cache all swap.
# "cswap" will be null if enabled.
# Swap will be 260MB or 520MB if "raid" = 1 .
# Note: /cache will be formated to swap, and
# you will need to reboot after the first boot
## (0 = default/disabled) (1 = enabled) ##
	aswap=0

# Raid 0
# Splits memory evenly across zram and /cache swap
# doing so makes swap about ~100% faster.
# Can be used on "cswap" or "aswap"
## (0 = default/disabled) (1 = enabled) ##
	raid=0

#   ------------------------<EXPERT>-----------------------   #

# Load override
if [ -e "$ORID" ]; then
	$LOGCATI " $ORID; loading "
	. $ORID
elif [ -e "$ORID".txt ]; then
	ORID+=.txt
	$LOGCATI " $ORID; loading "
	. $ORID
else
	$LOGCATI " no override; skipping "
fi
$BB swapoff -a # if the user does "start FI-d" also to reset
if [ "$cswap" -ge "1" ] && [ "$aswap" == "0" ]; then
	if [ -e "$CSWAP" ] && [ "$SIZE" == "$cswap" ]; then
		if [ "$zswap" -ge "1" ] && [ "$raid" == "0" ]; then
			$BB swapon -d -p 1 $CSWAP # zram with cswap
		elif [ "$zswap" == "0" ] && [ "$raid" == "1" ]; then
			$BB swapon -d -p 2 $CSWAP # raid 0
		elif [ "$zswap" == "0" ] && [ "$raid" == "0" ]; then
			$BB swapon -d $CSWAP # cswap only
		fi
	else
		if [ -e $CSWAP ]; then
			$LOGCATI " cache; changing size "
			dd if=/dev/zero of=$CSWAP bs="$cswap"m count=1
			if [ "$cswap" != "$SIZE" ]; then
				$LOGCATW " cache; is out of space "
			fi
		else
			dd if=/dev/zero of=$CSWAP bs="$cswap"m count=1
			if [ "$cswap" != "$SIZE" ]; then
				$LOGCATW " cache; is out of space "
			fi
		fi
		chmod 600 $CSWAP
		$BB mkswap $CSWAP
		if [ "$zswap" -ge "1" ] && [ "$raid" == "0" ]; then
			$BB swapon -d -p 1 $CSWAP # zram with cswap
		elif [ "$zswap" == "0" ] && [ "$raid" == "1" ]; then
			$BB swapon -d -p 2 $CSWAP # raid 0
		elif [ "$zswap" == "0" ] && [ "$raid" == "0" ]; then
			$BB swapon -d $CSWAP # cswap only
		fi
	fi
	if [ "$zswap" == "0" ] && [ "$raid" == "1" ]; then
		echo 1 > $ZRS/reset
		echo 1 > $ZRS/max_comp_streams
		echo lz4 > $ZRS/comp_algorithm
		if [ "$cswap" != "$SIZE" ]; then
			echo "$SIZE"M > $ZRS/disksize
			$LOGCATW " cache; is out of space "
		else
			echo "$cswap"M > $ZRS/disksize
		fi
		$BB mkswap $ZRB
		$BB swapon -d -p 2 $ZRB
	fi
fi
if [ "$zswap" == "0" ] && [ "$aswap" == "1" ]; then
	if [ -e "$CMOUNT" ]; then
		$BB umount /cache && $LOGCATI " cache; unmount successful "
		$BB mkswap $CACHE && $LOGCATI " cache; format successful "
	fi
	$BB mount -t tmpfs -o rw tmpfs /cache && $LOGCATI " mounted cache as tmpfs "
	$BB swapon -d -p 1 $CACHE # this will most likely fail if cache is formated on first startup, a reboot should fix it
	if [ "$raid" == "1" ]; then
		echo 1 > $ZRS/reset
		echo 1 > $ZRS/max_comp_streams
		echo lz4 > $ZRS/comp_algorithm
		echo "$PSIZE"M > $ZRS/disksize
		$BB mkswap $ZRB
		$BB swapon -d -p 1 $ZRB
	fi
fi
if [ "$zswap" -gt "1" ] && [ "$aswap" == "0" ] && [ "$raid" == "0" ]; then
	echo 1 > $ZRS/reset
	echo "$CORE" > $ZRS/max_comp_streams
	echo lz4 > $ZRS/comp_algorithm
	echo "$zswap"M > $ZRS/disksize
	$BB mkswap $ZRB
	if [ "$cswap" -ge "1" ]; then
		$BB swapon -d -p 2 $ZRB # zram with cswap, NOT raid 0
	else
		$BB swapon -d $ZRB # zram only
	fi
fi
if [ "$uksm" == "1" ]; then
	echo 500 > /sys/kernel/mm/uksm/sleep_millisecs
	echo 1 > /sys/kernel/mm/uksm/run
elif [ "$ksm" == "1" ]; then
	echo 100 > /sys/kernel/mm/ksm/pages_to_scan
	echo 500 > /sys/kernel/mm/ksm/sleep_millisecs
	echo 1 > /sys/kernel/mm/ksm/run
else # just to be safe
	if [ -e /sys/kernel/mm/ksm/run ]; then
		echo 0 > /sys/kernel/mm/ksm/run
	elif [ -e /sys/kernel/mm/uksm/run ]; then
		echo 0 > /sys/kernel/mm/uksm/run
	fi
fi
if [ "$lmk" == "0" ]; then
	echo 0 > /sys/module/lowmemorykiller/parameters/minfree  
elif [ "$lmk" == "2" ]; then
	echo "7680,11776,15872,19968,24064,28160" > /sys/module/lowmemorykiller/parameters/minfree
fi
if [ "$oc" == "0" ]; then
	echo 1 > /sys/kernel/tegra_gpu/gpu_cap_state
	echo 852000000 > /sys/kernel/tegra_gpu/gpu_cap_rate
fi
if [ "$gfix" == "1" ]; then
	echo 612000 > /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq
	echo "65 510000:75 714000:85" > /sys/devices/system/cpu/cpufreq/interactive/target_loads
	chmod 444 /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq
	chmod 444 /sys/devices/system/cpu/cpufreq/interactive/target_loads
fi
if [ "$dtw" == "0" ]; then
	echo 0 > /sys/devices/platform/spi-tegra114.2/spi_master/spi2/spi2.0/input/input0/wake_gesture
fi
if [ "$fs" == "0" ]; then
	echo 0 > /sys/module/sync/parameters/fsync_enabled
fi
if [ "$fc" == "1" ]; then
	echo 1 > /sys/kernel/fast_charge/force_fast_charge
fi
if [ -e $CSWAP ] && [ "$cswap" == "0" ]; then
	rm $CSWAP
fi
